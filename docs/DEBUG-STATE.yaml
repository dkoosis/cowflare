# MCP-DEBUG-STATE-V1
# Machine-optimized debugging state for Claude
# Update after each session with findings

meta:
  goal: "claude.ai->rtm_tasks"
  endpoint: "rtm-mcp-server.vcto-6e7.workers.dev"
  deployment: "strong-Minnie Moo"
  last_update: "2025-07-15T01:00:00Z"

state:
  build: "PASS"
  inspector_connect: "PASS"
  tool_execution: "PASS"
  auth_flow: "PASS"
  oauth_integration: "PASS"
  rtm_user_fetch: "PASS"
  claude_integration: "FAIL"
  mcp_connection: "FAIL"
  logging: "PASS"

proven:
- "rtm_auth!=oauth2_standard"
- "rtm_auth==desktop_flow"
- "tool_return=={content:[{type:'text',text:...}]}"
- "transport==streamable_http"
- "mcp_handler==RtmMCP.serve('/mcp',{...})"
- "corsOptions.origin==string"
- "hono_app==Hono<{Bindings:Env;Variables:Variables}>()"
- "oauth_flow==/authorize->frob->token->code->redirect"
- "deployment_name==Math.floor((Date.now()/1000)%adjectives.length)"
- "oauth_manual_test==success"
- "oauth_code_generation==working"
- "dashboard_import==dashboard.ts"
- "authorize_error_returns_html==fixed"
- "rtm_getToken_returns=={token,auth}"
- "real_user_data==fetched_from_rtm"
- "claude_redirect_uri==https://claude.ai/api/mcp/auth_callback"

failed:
- "serveStreamableHttp->2339"
- "origin:string[]->2322"
- "c.get('debugLogger')->2769"
- "getUserInfo->2339"
- "dashboard.txt->2307"
- "claude_ai_integration->shows_connect_after_oauth"
- "mcp_connection->no_requests_after_oauth"

hypotheses:
  h1:
    desc: "mcp_endpoint_not_properly_configured"
    test: "check_/mcp_handler_and_DO_init"
    priority: 1
  h2:
    desc: "token_not_passed_to_durable_object"
    test: "verify_DO_receives_auth_headers"
    priority: 2
  h3:
    desc: "claude_expects_different_transport"
    test: "check_streamable_http_implementation"
    priority: 3
  h4:
    desc: "resource_url_incorrect_in_token_response"
    test: "verify_${baseUrl}/mcp_is_correct"
    priority: 4

blockers:
- "mcp_connection_not_established_after_oauth"
- "no_mcp_requests_in_logs"

next_action: "test:/test/init-mcp"

code_refs:
  serve: "src/index.ts:L34"
  cors: "src/index.ts:L36"
  mcp_handler: "src/index.ts:L40-60"
  types: "src/rtm-handler.ts:L10-L14"
  getToken: "src/rtm-api.ts:L156-171"
  rtm_mcp_init: "src/rtm-mcp.ts:L26-40"
  test_endpoints: "src/index.ts:L98+"

errors_fixed:
  e1: "tool_response->wrap:{content:[...]}"
  e2: "serveStreamableHttp->serve"
  e3: "origin:[]->origin:string"
  e4: "unknown_logger->type:Variables"
  e5: "getUserInfo->mock_data"
  e6: "dashboard.txt->dashboard.ts"
  e7: "DebugEvent->import_type"
  e8: "authorize_json_error->html_error_page"
  e9: "getToken_string->getToken_object"

oauth_test:
  latest_flow:
    timestamp: "2025-07-15T00:47:27Z"
    user_id: "430794"
    username: "dkoosis"
    fullname: "David Koosis"
    isRealUser: true
    token: "9ab201dd80a641ca348f859d5cf545c2dc21d5e8"
    redirect: "https://claude.ai/api/mcp/auth_callback"
    result: "oauth_success_but_mcp_not_connected"

current_issues:
  mcp_connection:
    symptom: "claude_shows_connect_after_oauth"
    oauth_status: "completed_successfully"
    mcp_requests: "none_received"
    possible_causes:
    - "resource_url_misconfigured"
    - "mcp_transport_mismatch"
    - "durable_object_not_initialized"
    - "token_not_passed_to_DO"

test_urls:
- "/test/rtm - verify RTM credentials"
- "/test/mcp/[token] - test MCP init with token"
- "/test/init-mcp - test DO initialization"
- "/debug/tokens - list all tokens"
- "/debug - main debug dashboard"

sessions:
- ts: "2025-07-15T01:00:00Z"
  fixes: [ "rtm_real_user_data", "extensive_logging" ]
  time: 60
- ts: "2025-07-14T17:00:00Z"
  fixes: [ "blank_screen_diagnosis", "authorize_error_html" ]
  time: 30
- ts: "2025-07-14T16:30:00Z"
  fixes: [ "dashboard_import", "debug_endpoints" ]
  time: 30

metrics:
  orientation: [ 0, 120, 30, 5, 15, 20 ]
  redundant: [ 3, 0, 0, 0, 0, 0 ]
  hypothesis_success: [ 1, 1, 1, 1, 1 ]
  forward: true
