# MCP-DEBUG-STATE-V1
# Machine-optimized debugging state for Claude
# Update after each session with findings

meta:
  goal: "claude.ai->rtm_tasks"
  endpoint: "rtm-mcp-server.vcto-6e7.workers.dev"
  deployment: "graceful-eagle"
  last_update: "2025-07-14T19:45:00Z"

state:
  build: "PASS"
  inspector_connect: "PASS"
  tool_execution: "PASS"
  auth_flow: "PASS"
  claude_integration: "PARTIAL"
  logging: "FAIL_KV_LIMIT"

proven:
- "rtm_auth!=oauth2_standard"
- "rtm_auth==desktop_flow"
- "tool_return=={content:[{type:'text',text:...}]}"
- "transport==streamable_http"
- "mcp_handler==RtmMCP.serve('/mcp',{...})"
- "corsOptions.origin==string"
- "hono_app==Hono<{Bindings:Env;Variables:Variables}>()"
- "oauth_flow==/authorize->frob->token->code->redirect"
- "deployment_name==Math.floor((Date.now()/1000)%adjectives.length)"
- "oauth_manual_test==success"
- "oauth_code_generation==working"
- "dashboard_import==dashboard.ts"
- "claude_sends_redirect_uri==https://example.com/callback"
- "logging_endpoints==working"
- "claude_shows_connected_popup==true"
- "oauth_completes_successfully==true"

failed:
- "serveStreamableHttp->2339"
- "origin:string[]->2322"
- "c.get('debugLogger')->2769"
- "getUserInfo->2339"
- "dashboard.txt->2307"
- "claude_ai_integration->redirects_to_example.com"

hypotheses:
  h1:
    desc: "claude.ai_sends_wrong_redirect_uri"
    test: "check_oauth_authorize_params"
    priority: 1
    status: "CONFIRMED"
    solution: "intercept_and_replace_example.com"
  h2:
    desc: "logging_kv_issue"
    test: "test_kv_directly"
    priority: 2
    status: "RESOLVED"
  h3:
    desc: "claude_callback_url_pattern"
    test: "find_correct_claude_callback"
    priority: 1
    status: "NEEDS_TESTING"

blockers:
- "claude.ai_redirects_to_example.com_not_claude"
- "need_correct_claude_callback_url"

next_action: "test:claude_callback_url_variations"

code_refs:
  serve: "src/index.ts:L34"
  cors: "src/index.ts:L36"
  types: "src/rtm-handler.ts:L10-L14"
  mock_user: "src/rtm-handler.ts:L340-L350"
  dashboard: "src/dashboard.ts"
  test_log: "src/index.ts:L98"
  kv_debug: "src/index.ts:L116"
  authorize_fix: "src/rtm-handler.ts:L30-L55"

errors_fixed:
  e1: "tool_response->wrap:{content:[...]}"
  e2: "serveStreamableHttp->serve"
  e3: "origin:[]->origin:string"
  e4: "unknown_logger->type:Variables"
  e5: "getUserInfo->mock_data"
  e6: "dashboard.txt->dashboard.ts"
  e7: "DebugEvent->import_type"

oauth_test:
  url: "/authorize?response_type=code&client_id=test&redirect_uri=https://example.com/callback&state=test123"
  frob: "20bb29e2a290a306b28b977f08710e6076db3a6a"
  token: "9ab201dd..."
  code: "98d172c2-b8aa-4110-9f2f-ea830c8a212f"
  redirect: "https://example.com/callback?code=...&state=test123"
  result: "success_but_wrong_redirect"

current_issues:
  claude_ai_integration:
    symptom: "shows_requires_connection_after_oauth"
    redirect: "sends_to_example.com"
    expected: "should_redirect_to_claude.ai"
    root_cause: "claude_sends_redirect_uri=example.com"
    fix: "intercept_and_replace_in_authorize_endpoint"
  debug_logging:
    symptom: "no_logs_in_dashboard"
    test1: "/test-log"
    test2: "/debug/kv"
    test3: "/debug/all"
    status: "RESOLVED_endpoints_working"

claude_callback_patterns:
  observed: "https://example.com/callback"
  possible:
  - "https://claude.ai/api/auth/callback/custom"
  - "https://claude.ai/api/oauth/callback"
  - "https://claude.ai/auth/callback"
  - "https://claude.ai/integrations/callback"

sessions:
- ts: "2025-07-14T19:45:00Z"
  fixes: [ "kv_limit_diagnosed", "cleanup_endpoint_added" ]
  time: 15
- ts: "2025-07-14T19:10:00Z"
  fixes: [ "added_redirect_uri_fix" ]
  time: 10
- ts: "2025-07-14T19:00:00Z"
  fixes: [ "diagnosed_claude_redirect_issue", "verified_logging_works" ]
  time: 30
- ts: "2025-07-14T16:30:00Z"
  fixes: [ "dashboard_import", "debug_endpoints" ]
  time: 30
- ts: "2025-07-13T22:30:00Z"
  fixes: [ "hono_types", "oauth_test" ]
  time: 30
- ts: "2025-07-13T22:00:00Z"
  fixes: [ "serve", "cors" ]
  time: 10
- ts: "2025-07-13T18:00:00Z"
  fixes: [ "tool_return", "types" ]
  time: 240

metrics:
  orientation: [ 0, 120, 30, 5, 5 ]
  redundant: [ 3, 0, 0, 0, 0 ]
  hypothesis_success: [ 1, 1, 1, 1 ]
  forward: true
