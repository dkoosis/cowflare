# MCP-DEBUG-STATE-V1
# Machine-optimized debugging state for Claude
# Update after each session with findings

meta:
  goal: "claude.ai->rtm_tasks"
  endpoint: "rtm-mcp-server.vcto-6e7.workers.dev"
  deployment: "happy-owl"
  last_update: "2025-07-14T23:00:00Z"

state:
  build: "PASS"
  inspector_connect: "PASS"
  tool_execution: "PASS"
  auth_flow: "PASS"
  claude_integration: "FAIL"
  logging: "PASS"
  dashboard_display: "FAIL"

proven:
- "rtm_auth!=oauth2_standard"
- "rtm_auth==desktop_flow"
- "tool_return=={content:[{type:'text',text:...}]}"
- "transport==streamable_http"
- "mcp_handler==RtmMCP.serve('/mcp',{...})"
- "corsOptions.origin==string"
- "hono_app==Hono<{Bindings:Env;Variables:Variables}>()"
- "oauth_flow==/authorize->frob->token->code->redirect"
- "deployment_name==Math.floor((Date.now()/1000)%adjectives.length)"
- "oauth_manual_test==success"
- "oauth_code_generation==working"
- "dashboard_import==dashboard.ts"
- "logging_system==working"
- "oauth_logs_created==true"
- "claude_redirect_uri==https://claude.ai/api/mcp/auth_callback"
- "token_exchange==working"
- "token_storage_format==token:{rtmToken}"
- "mcp_expects==Authorization:Bearer_header"

failed:
- "serveStreamableHttp->2339"
- "origin:string[]->2322"
- "c.get('debugLogger')->2769"
- "getUserInfo->2339"
- "dashboard.txt->2307"
- "claude_ai_integration->shows_requires_connection"
- "dashboard_display->not_showing_oauth_logs"

hypotheses:
  h1:
    desc: "bearer_token_in_fetch_override"
    test: "override_RtmMCP.fetch()_to_extract_bearer_token"
    priority: 1
    details: "MCP protocol requires Authorization:Bearer on EVERY request. Override fetch() in RtmMCP to extract token, lookup in KV, update DO state"
    expected: "Claude.ai sends Bearer token -> RtmMCP extracts -> Updates auth state -> Tools work"
    risk: "McpAgent parent class may not allow fetch() override properly"
  h2:
    desc: "dashboard_template_issue"
    test: "increase_kv_limit_to_1000"
    priority: 2
    status: "testing"
  h3:
    desc: "do_props_not_passed"
    test: "verify_do_initialization"
    priority: 3
    status: "confirmed_issue"

blockers:
- "claude.ai_shows_requires_connection_after_oauth"
- "dashboard_auto_refresh_was_annoying"

TESTING_NOW: "Bearer_Token_Extraction_in_DO_Fetch"
TEST_HYPOTHESIS: "Claude.ai sends Authorization:Bearer header with token on every MCP request. If RtmMCP.fetch() extracts this token and updates auth state, tools should work."
IF_FAILS: "McpAgent parent class may not allow fetch() override OR Bearer token not sent with every request"

next_action: "deploy:test_bearer_token_extraction"

verification_steps:
- check: "build_succeeds"
  command: "npm run build && wrangler deploy"
- check: "claude_oauth_flow"
  steps:
  - "Complete OAuth in Claude.ai"
  - "Check /debug for mcp_auth_check events"
  - "Verify Bearer token in logs"
- check: "rtm_check_auth_status"
  expect: "Should show authenticated user"
- check: "timeline_create"
  expect: "Should work without auth_token param"
- check: "dashboard_ui"
  expect: "No auto-refresh, buttons visible"

code_refs:
  serve: "src/index.ts:L34"
  cors: "src/index.ts:L36"
  types: "src/rtm-handler.ts:L10-L14"
  mock_user: "src/rtm-handler.ts:L340-L350"
  dashboard: "src/dashboard.ts"
  test_log: "src/index.ts:L98"
  kv_debug: "src/index.ts:L116"
  getRecentFlowLogs: "src/debug-logger.ts:L108"
  createDebugDashboard: "src/debug-logger.ts:L207"
  fetch_override: "src/rtm-mcp.ts:L58-L95"
  token_lookup: "src/rtm-mcp.ts:L70"

errors_fixed:
  e1: "tool_response->wrap:{content:[...]}"
  e2: "serveStreamableHttp->serve"
  e3: "origin:[]->origin:string"
  e4: "unknown_logger->type:Variables"
  e5: "getUserInfo->mock_data"
  e6: "dashboard.txt->dashboard.ts"
  e7: "DebugEvent->import_type"
  e8: "logging_not_working->actually_working"

oauth_test_claude:
  session: "oauth_p1c1A5dwDfRV7kPvyBWg5q6G1iA5n66YdxWgjiXUfRc"
  redirect_uri: "https://claude.ai/api/mcp/auth_callback"
  code: "a0d2d780-b51a-44bf-80b3-f331cbeed354"
  redirect: "https://claude.ai/api/mcp/auth_callback?code=...&state=..."
  result: "oauth_success_but_mcp_connection_fails"

current_issues:
  claude_ai_integration:
    symptom: "shows_requires_connection_after_oauth"
    oauth_flow: "completes_successfully"
    redirect: "correct_to_claude.ai"
    token_stored: "verified_in_kv"
    possible_cause: "DO_not_receiving_bearer_token"
    test_approach: "override_fetch_method_in_RtmMCP"
  dashboard_display:
    symptom: "auto_refresh_collapses_views"
    missing: "export_delete_buttons"
    fix_applied: "removed_auto_refresh_added_buttons"

testing_now:
  approach: "bearer_token_extraction_in_do_fetch"
  files_modified:
  - "src/rtm-mcp.ts->override_fetch_method"
  - "src/dashboard.ts->fix_ui_issues"
  expected_flow:
  - "Claude.ai_completes_oauth"
  - "Claude.ai_connects_to_/mcp_with_Bearer_token"
  - "RtmMCP.fetch()_extracts_token"
  - "Lookup_token_in_KV_storage"
  - "Update_DO_auth_state"
  - "Tools_work_with_auth"
  risk_factors:
  - "McpAgent_may_not_support_fetch_override"
  - "Token_might_not_be_in_every_request"
  - "DO_lifecycle_might_reset_auth_state"

sessions:
- ts: "2025-07-14T23:00:00Z"
  fixes: [ "bearer_token_fetch_override_attempt", "dashboard_ui_fixes" ]
  time: 30
- ts: "2025-07-14T22:30:00Z"
  fixes: [ "identified_logs_working", "found_claude_correct_redirect" ]
  time: 15
- ts: "2025-07-14T16:30:00Z"
  fixes: [ "dashboard_import", "debug_endpoints" ]
  time: 30
- ts: "2025-07-13T22:30:00Z"
  fixes: [ "hono_types", "oauth_test" ]
  time: 30
- ts: "2025-07-13T22:00:00Z"
  fixes: [ "serve", "cors" ]
  time: 10
- ts: "2025-07-13T18:00:00Z"
  fixes: [ "tool_return", "types" ]
  time: 240

dead_ends:
- attempt: "dynamic_props_in_serve"
  reason: "serve()_method_doesnt_support_dynamic_props"
  learned: "props_must_be_static_or_from_request"

metrics:
  orientation: [ 0, 120, 30, 5, 15, 30 ]
  redundant: [ 3, 0, 0, 0, 0, 1 ]
  hypothesis_success: [ 1, 1, 1, 1, 0 ]
  forward: true
